---
title: "Correlations ICARS/SARA/mFARS"
author: "Christian Rummey"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    df_print: paged
    number_sections: yes
  word_document:
    toc: yes
    number_sections: yes
editor_options:
  chunk_output_type: inline
  markdown:
    wrap: 100
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=8.5, fig.height=5.5, fig.align='center', echo=F, warning=F, message=F, cache=F)
```

```{r, echo = F, message = F}
library(corrr)
require(lme4)
require(lmerTest)
require(optimx)
require(broom.mixed)

.lme4.ctrl      <- lmerControl( 
  optimizer = "optimx", 
  calc.derivs = FALSE, 
  optCtrl = list(method = "L-BFGS-B" , 
                 starttests = FALSE, 
                 kkt = FALSE, 
                 # maxiter = 10000, 
                 save.failures = T)) # def iterations 500

dt. <- readRDS('DATA derived/long.data.rds') %>% 
  mutate(paramcd = factor(paramcd, c('mFARS','SARA','ICARS','FARS.E','SARA.ax','ICARS.gp','FARS.B', 'SARA.ki', 'ICARS.ki')))

dt.ki <- dt. %>% 
  filter(paramcd %in% c('FARS.B', 'ICARS.ki','SARA.ki')) %>% 
  spread(paramcd, aval)

dt.gp <- dt. %>% 
  filter(paramcd %in% c('FARS.E', 'ICARS.gp','SARA.ax')) %>% 
  spread(paramcd, aval)

dt. %<>% 
  filter(paramcd %in% c('mFARS', 'ICARS','SARA')) %>% 
  spread(paramcd, aval)


dt.all <- bind_rows( 
  dt. %>% mutate(dep = 'mFARS') %>% rename(score = mFARS) %>% gather(paramcd, aval, SARA , ICARS), 
  dt. %>% mutate(dep = 'SARA' ) %>% rename(score = SARA ) %>% gather(paramcd, aval, mFARS, ICARS), 
  dt. %>% mutate(dep = 'ICARS') %>% rename(score = ICARS) %>% gather(paramcd, aval, SARA , mFARS)
)

dt.l.gp <- bind_rows( 
  dt.gp %>% mutate(dep = 'FARS.E')   %>% rename(score = FARS.E  ) %>% gather(paramcd, aval, SARA.ax , ICARS.gp), 
  dt.gp %>% mutate(dep = 'SARA.ax' ) %>% rename(score = SARA.ax ) %>% gather(paramcd, aval, FARS.E  , ICARS.gp), 
  dt.gp %>% mutate(dep = 'ICARS.gp') %>% rename(score = ICARS.gp) %>% gather(paramcd, aval, SARA.ax , FARS.E)
)

dt.l.ki <- bind_rows( 
  dt.ki %>% mutate(dep = 'FARS.B')   %>% rename(score = FARS.B   ) %>% gather(paramcd, aval, SARA.ki , ICARS.ki), 
  dt.ki %>% mutate(dep = 'SARA.ki' ) %>% rename(score = SARA.ki  ) %>% gather(paramcd, aval, FARS.B, ICARS.ki), 
  dt.ki %>% mutate(dep = 'ICARS.ki') %>% rename(score = ICARS.ki ) %>% gather(paramcd, aval, SARA.ki , FARS.B)
)


```

# Summary

1)  Ataxia Scores can be reliably converted across all ataxia stages

    -   this works reliably to acess staging

    -   when assessing progression, ambulation status needs to be taken into account.

2)  There results are based on specific (show) population

3)  There is a danger for error in earier/younger populations.

4)  Formulas for Conversion of Total Ataxia Scores

```{r}
tmp  <- dt. %>% select(sjid, age, mFARS, SARA, ICARS) %>% mutate(type = 'scale')
tmp2 <- dt. %>% select(sjid, age, mFARS, SARA, ICARS) %>% mutate(type = 'pct') %>% 
  mutate(mFARS = 100*mFARS/93) %>% 
  mutate(SARA  = 100*SARA/40) %>% 
  mutate(ICARS = 100*ICARS/93)

bind_rows(
  tmp  %>% rename(score = mFARS) %>% mutate(dep = 'mFARS') %>% gather(indep, value, SARA, ICARS),
  tmp  %>% rename(score = SARA ) %>% mutate(dep = 'SARA' ) %>% gather(indep, value, mFARS, ICARS),
  tmp  %>% rename(score = ICARS) %>% mutate(dep = 'ICARS') %>% gather(indep, value, mFARS, SARA),
  tmp2 %>% rename(score = mFARS) %>% mutate(dep = 'mFARS') %>% gather(indep, value, SARA, ICARS),
  tmp2 %>% rename(score = SARA ) %>% mutate(dep = 'SARA' ) %>% gather(indep, value, mFARS, ICARS),
  tmp2 %>% rename(score = ICARS) %>% mutate(dep = 'ICARS') %>% gather(indep, value, mFARS, SARA)
) %>% 
  group_by(type, dep, indep) %>% 
  nest() %>% 
  mutate ( lm.mod = map( data  , ~ lm (score ~ value, data = .))) %>% 
  mutate ( coef   = map( lm.mod, ~ broom::tidy (.))) %>% 
  unnest ( coef ) %>% 
  select ( dep, indep, term, estimate) %>% 
  spread ( term, estimate ) %>% 
  rename ( intercept = `(Intercept)`, slope = value ) %>% 
  mutate ( dep   = factor(dep, c('mFARS', 'SARA', 'ICARS'))) %>% 
  mutate ( indep = factor(indep, c('mFARS', 'SARA', 'ICARS'))) %>% 
  arrange( type, dep, indep) %>% 
  pivot_wider(id_cols = c('type', 'dep', 'indep'), names_from = c('type'), values_from = c('intercept', 'slope') ) %>% 
  select(dep, indep, intercept_scale, slope_scale, intercept_pct, slope_pct) %>% 
  flextable() %>% 
  colformat_double(digits = 2) %>% 
  set_header_labels(values = list(dep = '', indep = 'predicted from', 
                                  intercept_scale = 'intercept',
                                  slope_scale     = 'slope',
                                  intercept_pct   = 'intercept',
                                  slope_pct   = 'slope')) %>% 
  add_header_row(values = c('','Points','%'), colwidths = c(2, 2, 2)) %>% 
  align(j = c(1:6), part = 'all', align = 'center'  ) %>% 
  hline(i = c(2, 4))
```

# Methods

## Subscales Definitions

+----------------------+-----------+---------------------------------------------------------------+
| Subscore             | short     | Items                                                         |
+======================+===========+===============================================================+
| SARA Axial           | SARA.ax   | Gait (8), stance (6), sit (4)                                 |
+----------------------+-----------+---------------------------------------------------------------+
| SARA Kinetic         | SARA.ki   | Finger Chase (4), Finger Nose (4), Alternating Hand movements |
| Function             |           | (4), Heel Shin Slide (4)                                      |
+----------------------+-----------+---------------------------------------------------------------+
| ICARS Gait/Posture   | ICARS.gp  | walk, gait, stand eyes open, spread of feet, body sway eyes   |
|                      |           | open/closed, sitting                                          |
+----------------------+-----------+---------------------------------------------------------------+
| ICARS Kinetic        | ICARS.ki  | nee tibia, heel to knee, finger nose dysmetria/tremor,        |
| Function             |           | finger-finger, lterning hand movements, spiral draw           |
+----------------------+-----------+---------------------------------------------------------------+

# Results

## Correlation Plots

### Total Scores

#### mFARS vs SARA

```{r}

dt <- dt. %>%
  # mutate(SARA = SARA/40) %>%
  # mutate(mFARS = mFARS/93) %>% 
  mutate(group = ifelse(SARA <= 8, 'low', 'high'))

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = SARA, y = mFARS)+
  aes(color = group)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T, color = 'black', label.y = 75)+
  geom_smooth(method = lm, se = F, color = 'black')+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

```

#### mFARS vs ICARS

```{r}

dt <- dt. %>%
  mutate(group = ifelse(ICARS <=20, 'low', 'high'))

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = ICARS, y = mFARS)+
  aes(color = group)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T, color = 'black', label.y = 75)+
  geom_smooth(method = lm, se = F, color = 'black')+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

```

### Axial Function

#### FARS E vs SARA.ax

```{r}

dt <- dt.gp %>%
  mutate(group = ifelse(SARA.ax <=4, 'low', 'high'))

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = SARA.ax, y = FARS.E)+
  aes(color = group)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T, color = 'black', label.y = 38)+
  geom_smooth(method = lm, se = F, color = 'black')+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

```

#### FARS E vs ICARS.gp

```{r}

dt <- dt.gp %>%
  mutate(group = ifelse(ICARS.gp <=8, 'low', 'high'))

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = ICARS.gp, y = FARS.E)+
  aes(color = group)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T, color = 'black', label.y = 38)+
  geom_smooth(method = lm, se = F, color = 'black')+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

```

### Appendicular Function

#### FARS B vs SARA.ki

```{r}

dt <- dt.ki

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = SARA.ki, y = FARS.B)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

```

#### FARS B vs SARA.ki

```{r}

dt <- dt.ki

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = ICARS.ki, y = FARS.B)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

```

