---
title: "Correlations ICARS/SARA/mFARS"
author: "Christian Rummey"
date: "`r Sys.Date()`"
output:
  word_document:
    toc: no
    number_sections: yes
  html_document:
    toc: yes
    df_print: paged
    number_sections: yes
editor_options:
  chunk_output_type: console
  markdown:
    wrap: 100
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=5, fig.align='center', echo=F, warning=F, message=F, cache=F)

```

```{r prepare data, echo = F, message = F}

rm(list=ls())

scales.list <- c('FARSn',
                 'mFARS'   ,'SARA'      ,'ICARS',
                 'FARS.E'  ,'SARA.ax'   ,'ICARS.ax',
                 'FARS.BC' ,'SARA.ki'   ,'ICARS.ki',
                 'FARS.Am' ,'s4.speech' ,'ICARS.sp',
                 'ICARS.od')

mx.    <- .rt('../DATA other/scales.txt') %>% 
  filter(paramcd %in% scales.list) %>% select(paramcd, maxscore) %>% 
  mutate(paramcd = factor(paramcd, scales.list))

dt. <- readRDS('DATA derived/long.data.rds') %>%
  group_by(sjid, paramcd, amb) %>% 
  mutate(paramcd = factor(paramcd, c(scales.list))) %>% 
  select(study, sjid, avisitn, age, amb, fds, type, type2, paramcd, aval)
  
  
dt.w <- dt. %>%
  spread(paramcd, aval)

scores. <- bind_rows(
  dt.w %>% mutate(score = mFARS, dep = 'mFARS') %>% select(-scales.list[!(scales.list %in% scales.list[c(1,3:4)] )]) %>% gather(indep, value, scales.list[c(1,3:4)]),
  dt.w %>% mutate(score = SARA , dep = 'SARA' ) %>% select(-scales.list[!(scales.list %in% scales.list[c(2,4)]   )]) %>% gather(indep, value, scales.list[c(2,4)]),
  dt.w %>% mutate(score = ICARS, dep = 'ICARS') %>% select(-scales.list[!(scales.list %in% scales.list[c(2,3)]   )]) %>% gather(indep, value, scales.list[c(2,3)]),
  dt.w %>% mutate(score = FARS.E  , dep = 'FARS.E'  ) %>% select(-scales.list[!(scales.list %in% scales.list[c(6,7)] )]) %>% gather(indep, value, scales.list[c(6,7)]),
  dt.w %>% mutate(score = SARA.ax , dep = 'SARA.ax' ) %>% select(-scales.list[!(scales.list %in% scales.list[c(5,7)] )]) %>% gather(indep, value, scales.list[c(5,7)]),
  dt.w %>% mutate(score = ICARS.ax, dep = 'ICARS.ax') %>% select(-scales.list[!(scales.list %in% scales.list[c(5,6)] )]) %>% gather(indep, value, scales.list[c(5,6)]),
  dt.w %>% mutate(score = FARS.BC , dep = 'FARS.BC' ) %>% select(-scales.list[!(scales.list %in% scales.list[c( 9,10)] )]) %>% gather(indep, value, scales.list[c(9,10)]),
  dt.w %>% mutate(score = SARA.ki , dep = 'SARA.ki' ) %>% select(-scales.list[!(scales.list %in% scales.list[c( 8,10)] )]) %>% gather(indep, value, scales.list[c(8,10)]),
  dt.w %>% mutate(score = ICARS.ki, dep = 'ICARS.ki') %>% select(-scales.list[!(scales.list %in% scales.list[c( 8, 9)] )]) %>% gather(indep, value, scales.list[c(8,9)]),
  dt.w %>% mutate(score = mFARS, dep = 'FARS.Am'  ) %>% select(-scales.list[!(scales.list %in% scales.list[c(12,13)] )]) %>% gather(indep, value, scales.list[c(12,13)]),
  dt.w %>% mutate(score = mFARS, dep = 's4.speech') %>% select(-scales.list[!(scales.list %in% scales.list[c(11,13)] )]) %>% gather(indep, value, scales.list[c(11,13)]),
  dt.w %>% mutate(score = mFARS, dep = 'ICARS.sp' ) %>% select(-scales.list[!(scales.list %in% scales.list[c(11,12)] )]) %>% gather(indep, value, scales.list[c(11,12)])
  ) 

# add a split

scores.amb <- scores. %>% 
  filter( amb == 'ambulatory' ) %>% 
  group_by( dep, indep ) %>% 
  filter(  dep %in% scales.list[c(2,3,4,5,6,7)]) %>% 
  filter(indep %in% scales.list[c(2,3,4,5,6,7)]) %>% 
  # left_join(mx. %>% mutate(maxscore = maxscore*.5) %>% rename(indep = paramcd, split.val = maxscore)) %>%
  # mutate ( split.val = case_when (
  #   indep == 'SARA' ~ 9,
  #   indep == 'ICARS', 23, 
  #   indep == 'mFARS', 21,
  #   indep == 'FARSn', 24, 
  #   NA)) %>%
  filter ( !is.na(value) ) %>% 
  mutate ( split.val = median(value) ) %>% 
  mutate ( split = ifelse(value < split.val, 'low','hig') )


```

```{r calculate coefficients, echo = F, message = F}

coeffs. <- scores. %>% 
  group_by(type, type2, dep, indep) %>% 
  nest() %>% 
  mutate ( lm.mod = map( data  , ~ lm (score ~ value, data = .))) %>% 
  mutate ( coef   = map( lm.mod, ~ broom::tidy (.))) %>% 
  unnest ( coef ) %>% 
  select ( type, type2, dep, indep, term, estimate) %>% 
  spread ( term, estimate ) %>% 
  rename ( inter = `(Intercept)`, slope = value ) %>% 
  mutate ( dep   = factor(dep  , scales.list )) %>% 
  mutate ( indep = factor(indep, scales.list )) %>% 
  ungroup %>% 
  arrange( type, type2, dep, indep )

coeffs.amb <- scores.amb %>% 
  group_by(type, type2, dep, indep, split ) %>% 
  nest() %>% 
  mutate ( lm.mod = map( data  , ~ lm (score ~ value, data = .))) %>% 
  mutate ( coef   = map( lm.mod, ~ broom::tidy (.))) %>% 
  unnest ( coef ) %>% 
  select ( type, type2, dep, indep, split, term, estimate) %>% 
  spread ( term, estimate ) %>% 
  rename ( inter = `(Intercept)`, slope = value ) %>% 
  mutate ( dep   = factor(dep  , scales.list )) %>% 
  mutate ( indep = factor(indep, scales.list )) %>% 
  ungroup %>% 
  droplevels() %>% 
  arrange( type, type2, dep, indep )

coeffs. %>% 
  bind_rows(coeffs.amb) %>% 
  saveRDS('DATA derived/coefficients.rds')

```

```{r Supplementary Table}

table.s1 <- coeffs. %>%
  filter(type2 == 'all') %>% 
  pivot_wider(id_cols = c('type2','dep', 'indep'), names_from = c('type'), values_from = c('inter', 'slope') ) %>%
  select(dep, indep, inter_val, slope_val, inter_pct, slope_pct) 

table.s1 %>%
  # filter(!((dep == 'SARA' | dep == 'ICARS') & indep == 'FARSn')) %>% 
  flextable() %>% 
  colformat_double(digits = 2) %>% 
  set_header_labels(values = list(dep = '', indep = 'predicted from', 
                                  inter_val  = 'intercept',
                                  slope_val  = 'slope',
                                  inter_pct  = 'intercept',
                                  slope_pct  = 'slope')) %>% 
  add_header_row(values = c('','Points','%'), colwidths = c(2, 2, 2)) %>% 
  align(j = c(1:6), part = 'all', align = 'center'  ) %>% 
  hline(i = c(1,seq(3,23,2))) %>% 
  set_caption("Conversion Coefficients for full Scales",
              autonum = run_autonum(seq_id = "tab", bkm = "full")) %>% 
  set_table_properties( layout = "autofit" )


```

```{r split scores}

coeffs.amb %>%
  filter( type  == 'pct' ) %>% 
  filter( type2 == 'all' ) %>% 
  pivot_wider(id_cols = c('dep', 'indep'), names_from = c('split'), values_from = c('inter', 'slope') ) %>%
  select(dep, indep, inter_low, slope_low, inter_hig, slope_hig) %>%  
  flextable() %>% 
  colformat_double(digits = 2) %>% 
  set_header_labels(values = list(dep = '', indep = 'predicted from', 
                                  inter_low = 'intercept',
                                  slope_low = 'slope',
                                  inter_hig = 'intercept',
                                  slope_hig = 'slope')) %>% 
  add_header_row(values = c('','Points','%'), colwidths = c(2, 2, 2)) %>% 
  align(j = c(1:6), part = 'all', align = 'center'  ) %>% 
  hline(i = seq(2,12, 2)) %>% 
  set_caption("Conversion Coefficients for split scales (median in ambulatory)",
              autonum = run_autonum(seq_id = "tab", bkm = "full")) %>% 
  set_table_properties( layout = "autofit" )

```
