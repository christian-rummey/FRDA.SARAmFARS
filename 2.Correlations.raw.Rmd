---
title: "Correlations ICARS/SARA/mFARS"
author: "Christian Rummey"
date: "`r Sys.Date()`"
output:
  word_document:
    toc: no
    number_sections: yes
  html_document:
    toc: yes
    df_print: paged
    number_sections: yes
editor_options:
  chunk_output_type: inline
  markdown:
    wrap: 100
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=5, fig.align='center', echo=F, warning=F, message=F, cache=F)

library(corrr)
```

```{r, echo = F, message = F}

dt. <- readRDS('DATA derived/long.data.rds') %>% 
  mutate(paramcd = factor(paramcd, c('FARSn','mFARS','SARA','ICARS','FARS.E','SARA.ax','ICARS.ax','FARS.BC', 'SARA.ki', 'ICARS.ki'))) %>% 
  filter(forslope == 1) %>% 
  select(-c('forslope', 'int', 'chg', 'dev.y')) %>% 
  select(-time.) # has rounding issues, see 4208


dt.ki <- dt. %>% 
  filter(paramcd %in% c('FARS.BC', 'ICARS.ki','SARA.ki')) %>% 
  spread(paramcd, aval)

dt.gp <- dt. %>% 
  filter(paramcd %in% c('FARS.E', 'ICARS.ax','SARA.ax')) %>% 
  spread(paramcd, aval)

dt. %<>% 
  filter(paramcd %in% c('FARSn','mFARS', 'ICARS','SARA')) %>% 
  spread(paramcd, aval)

```

# Summary

- Ataxia scores can be reliably converted, to comparatively assess disease stage. 

- This is not valid when assessing progression, due to subtle differences in how the scores behave, and progression differs between disease phases (ambulatory vs non-ambulatory) 

- mFARS is the most suitable reference score.

-	Reasons: 

  1) mFARS (FARS E) is assessing key stance/balance functions that is lost very early (often pre-diagnosis), or is never attained. 
  2) Because some of these functions are maxed out in most patients, converstion to mFARS requires a large intercept (see table below). 
  3) Balance function in mFARS is assessed in a more objective (timed) way, compared to other ataxia scales.  
  4) These functions should also make mFARS more sensitive in early diesease stages.

- Stance function overall is assessed  in the mFARS. Therefore, in the early phase (SARA<=8, ICARS<=20), mFARS (FARS E) is likely the superior tool. 
-	At such low scores, alternative conversion factors should be used (see graphs)
-	Appendicular function correlates well overall, between all three scores. 



```{r}
tmp  <- dt. %>% select(sjid, age, mFARS, FARSn, SARA, ICARS) %>% mutate(type = 'scale')
tmp2 <- dt. %>% select(sjid, age, mFARS, FARSn, SARA, ICARS) %>% mutate(type = 'pct') %>% 
  mutate(mFARS = 100*mFARS /93 ) %>% 
  mutate(SARA  = 100*SARA  /40 ) %>% 
  mutate(ICARS = 100*ICARS /100)

scores. <- bind_rows(
  tmp  %>% rename(score = mFARS) %>% mutate(dep = 'mFARS') %>% gather(indep, value, SARA, ICARS, FARSn),
  tmp  %>% rename(score = FARSn) %>% mutate(dep = 'FARSn') %>% gather(indep, value, SARA, ICARS, mFARS),
  tmp  %>% rename(score = SARA ) %>% mutate(dep = 'SARA' ) %>% gather(indep, value, mFARS, ICARS, FARSn),
  tmp  %>% rename(score = ICARS) %>% mutate(dep = 'ICARS') %>% gather(indep, value, mFARS, SARA, FARSn),
  tmp2 %>% rename(score = mFARS) %>% mutate(dep = 'mFARS') %>% gather(indep, value, SARA, ICARS, FARSn),
  tmp2 %>% rename(score = FARSn) %>% mutate(dep = 'FARSn') %>% gather(indep, value, SARA, ICARS, mFARS),
  tmp2 %>% rename(score = SARA ) %>% mutate(dep = 'SARA' ) %>% gather(indep, value, mFARS, ICARS, FARSn),
  tmp2 %>% rename(score = ICARS) %>% mutate(dep = 'ICARS') %>% gather(indep, value, mFARS, SARA, FARSn)
) 

table <- scores. %>% 
  group_by(type, dep, indep) %>% 
  nest() %>% 
  mutate ( lm.mod = map( data  , ~ lm (score ~ value, data = .))) %>% 
  mutate ( coef   = map( lm.mod, ~ broom::tidy (.))) %>% 
  unnest ( coef ) %>% 
  select ( dep, indep, term, estimate) %>% 
  spread ( term, estimate ) %>% 
  rename ( intercept = `(Intercept)`, slope = value ) %>% 
  mutate ( dep   = factor(dep, c('mFARS', 'FARSn','SARA', 'ICARS'))) %>% 
  mutate ( indep = factor(indep, c('mFARS', 'FARSn', 'SARA', 'ICARS'))) %>% 
  arrange( type, dep, indep) %>% 
  pivot_wider(id_cols = c('dep', 'indep'), names_from = c('type'), values_from = c('intercept', 'slope') ) %>% 
  select(dep, indep, intercept_scale, slope_scale, intercept_pct, slope_pct) 

table %>%
  # filter(!((dep == 'SARA' | dep == 'ICARS') & indep == 'FARSn')) %>% 
  flextable() %>% 
  colformat_double(digits = 2) %>% 
  set_header_labels(values = list(dep = '', indep = 'predicted from', 
                                  intercept_scale = 'intercept',
                                  slope_scale     = 'slope',
                                  intercept_pct   = 'intercept',
                                  slope_pct   = 'slope')) %>% 
  add_header_row(values = c('','Points','%'), colwidths = c(2, 2, 2)) %>% 
  align(j = c(1:6), part = 'all', align = 'center'  ) %>% 
  hline(i = c(3, 6)) %>% 
  set_caption("Conversion Coefficients for full Scales",
              autonum = run_autonum(seq_id = "tab", bkm = "full"))

table <- scores. %>% 
  mutate(threshold = ifelse(indep == 'SARA', 9, ifelse(indep == 'ICARS', 23, ifelse(indep == 'mFARS', 21, ifelse(indep == 'FARSn', 24, NA))))) %>% 
  filter(value<threshold) %>% 
  group_by(type, dep, indep, threshold) %>% 
  nest() %>% 
  mutate ( lm.mod = map( data  , ~ lm (score ~ value, data = .))) %>% 
  mutate ( coef   = map( lm.mod, ~ broom::tidy (.))) %>% 
  unnest ( coef ) %>% 
  select ( dep, indep, threshold, term, estimate) %>% 
  spread ( term, estimate ) %>% 
  rename ( intercept = `(Intercept)`, slope = value ) %>% 
  mutate ( dep   = factor(dep, c('mFARS', 'FARSn','SARA', 'ICARS'))) %>% 
  mutate ( indep = factor(indep, c('mFARS', 'FARSn', 'SARA', 'ICARS'))) %>% 
  arrange( type, dep, indep) %>% 
  pivot_wider(id_cols = c('dep', 'indep','threshold'), names_from = c('type'), values_from = c('intercept', 'slope') ) %>% 
  select(dep, indep, threshold, intercept_scale, slope_scale, intercept_pct, slope_pct) 

table %>%
  filter(!((dep == 'SARA' | dep == 'ICARS') & indep == 'FARSn')) %>% 
  flextable() %>% 
  colformat_double(digits = 2) %>% 
  set_header_labels(values = list(dep = '', indep = 'predicted from', 
                                  intercept_scale = 'intercept',
                                  slope_scale     = 'slope',
                                  intercept_pct   = 'intercept',
                                  slope_pct   = 'slope')) %>% 
  add_header_row(values = c('','Points','%'), colwidths = c(3, 2, 2)) %>% 
  align(j = c(1:6), part = 'all', align = 'center'  ) %>% 
  hline(i = c(3, 5)) %>% 
  set_caption("Conversion Coefficients for lower End of the Scales (early patients)",
              autonum = run_autonum(seq_id = "tab", bkm = "full"))
  


```


# Methods

## Definitions Subscales used in the Comparisons 

| Subscore               | short    | Items                                                                                                      |
|-----------------------|-----------------------|-------------------------------------------------------|
| SARA Axial             | SARA.ax  | Gait (8), stance (6), sit (4)                                                                              |
| SARA Kinetic Function  | SARA.ki  | Finger Chase (4), Finger Nose (4), Alternating Hand movements (4), Heel Shin Slide (4)                     |
| ICARS Gait/Posture     | ICARS.gp | walk, gait, stand eyes open, spread of feet, body sway eyes open/closed, sitting                           |
| ICARS Kinetic Function | ICARS.ki | nee tibia, heel to knee, finger nose dysmetria/tremor, finger-finger, lterning hand movements, spiral draw |

# Results

## Correlation Plots

### Total Scores

#### mFARS vs SARA

```{r}

dt <- dt. %>%
  # mutate(SARA = SARA/40) %>%
  # mutate(mFARS = mFARS/93) %>% 
  mutate(group = ifelse(SARA <= 8, 'low', 'high'))

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = SARA, y = mFARS)+
  aes(color = group)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T, color = 'black', label.y = 75)+
  geom_smooth(method = lm, se = F, color = 'black')+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

```

#### mFARS vs ICARS

```{r}

dt <- dt. %>%
  mutate(group = ifelse(ICARS <=20, 'low', 'high'))

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = ICARS, y = mFARS)+
  aes(color = group)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T, color = 'black', label.y = 75)+
  geom_smooth(method = lm, se = F, color = 'black')+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

```

#### SARA vs ICARS

```{r}

dt <- dt. %>%
  mutate(group = ifelse(SARA <=8 , 'low', 'high'))

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = ICARS, y = SARA)+
  aes(color = group)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T, color = 'black', label.y = 30)+
  geom_smooth(method = lm, se = F, color = 'black')+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

```

#### FARSn vs mFARS

```{r}

dt <- dt. %>%
  mutate(group = ifelse(FARSn <=24 , 'low', 'high'))

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = FARSn, y = mFARS)+
  aes(color = group)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T, color = 'black', label.y = 30)+
  geom_smooth(method = lm, se = F, color = 'black')+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

dt <- dt. %>%
  mutate(group = ifelse(FARSn <=20, 'low', 'high'))

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = ICARS, y = SARA)+
  aes(color = group)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T, color = 'black', label.y = 30)+
  geom_smooth(method = lm, se = F, color = 'black')+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

dt <- dt. %>%
  mutate(group = ifelse(SARA <9 | ICARS <=23, 'low', 'high'))

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = FARSn, y = mFARS)+
  aes(color = group)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T, color = 'black', label.y = 30)+
  geom_smooth(method = lm, se = F, color = 'black')+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none


```



### Axial Function

#### FARS E vs SARA.ax

```{r}

dt <- dt.gp %>%
  mutate(group = ifelse(SARA.ax <=4, 'low', 'high'))

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = SARA.ax, y = FARS.E)+
  aes(color = group)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T, color = 'black', label.y = 38)+
  geom_smooth(method = lm, se = F, color = 'black')+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

```

#### FARS E vs ICARS.gp

```{r}

dt <- dt.gp %>%
  mutate(group = ifelse(ICARS.ax <=8, 'low', 'high'))

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = ICARS.ax, y = FARS.E)+
  aes(color = group)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T, color = 'black', label.y = 38)+
  geom_smooth(method = lm, se = F, color = 'black')+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

```

### Appendicular Function

#### FARS BC vs SARA.ki

```{r}

dt <- dt.ki

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = SARA.ki, y = FARS.BC)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

```

#### FARS BC vs SARA.ki

```{r}

dt <- dt.ki

dt %>% 
  mutate(title = 'all observations') %>% 
  bind_rows( dt %>%
               group_by(sjid) %>% 
               filter(age == min(age)) %>%
               mutate(title = 'first observation only')) %>%
  ggplot()+geom_point(alpha = .4)+
  facet_wrap(~title)+
  aes(x = ICARS.ki, y = FARS.BC)+
  ggpubr::stat_regline_equation(na.rm = T, show.legend = T)+
  geom_smooth(method = lm, se = F)+
  .leg_none

```
